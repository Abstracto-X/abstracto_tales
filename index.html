<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Codex</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. THEME DEFINITION: "CODEX" --- */
        :root {
            --bg-color: #fdf6e3; /* Parchment Paper */
            --text-color: #3c3631; /* Dark Charcoal */
            --header-color: #2b2622;
            --accent-color: #9a2d2d; /* Deep Red */
            --border-color: #dcd3bc;
            --font-header: 'Cinzel', serif;
            --font-body: 'Lora', serif;
        }

        /* --- 2. BASE SETUP --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-body);
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N3d3dtbW17e3t1dXVhYWHg4ODKysqOjo6BgYGNjY1xcXFiYmJqampwcHB0dHRsbGzCwsLeerLy8vLz8/P29vb39/f5+fn9/f3+pqcxAAAAG0lEQVRIx8XAgQkAMAzDQIH/d/2j9gYtjVphao4m8IoxsM4495Jg8JBfBEFwXwYgwqQ8EAFbQjQEwT8rQiMgQoO8BEABx3A/gQAZ0QFbQPwz8A6cI44/jA8kygDj6K8AAAAASUVORK5CYII=');
            background-repeat: repeat;
        }

        /* Container & Scrolling */
        #app-container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        #content-stage { overflow-x: hidden; }

        /* --- 3. NAVIGATION --- */
        #main-header {
            padding-bottom: 2rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-family: var(--font-header); font-size: 2.5rem; letter-spacing: 5px; color: var(--header-color); cursor: pointer; }
        .back-btn-wrapper { color: var(--accent-color); font-family: var(--font-header); cursor: pointer; }

        /* --- 4. HOME PAGE (TABLE OF CONTENTS) --- */
        .codex-list { list-style: none; }
        .codex-list-item {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 2rem;
            align-items: flex-start;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .codex-list-item:hover { background-color: rgba(0,0,0,0.03); }
        .item-illumination {
            width: 80px; height: 80px; flex-shrink: 0;
            border-radius: 50%; border: 2px solid var(--border-color);
            object-fit: cover;
        }
        .item-details h2 { font-family: var(--font-header); color: var(--header-color); margin-bottom: 0.5rem; }
        .item-details p { font-size: 1rem; line-height: 1.6; color: #5a5149; }

        /* --- 5. STORY HUB --- */
        .codex-hub { text-align: center; padding: 2rem 0; }
        .hub-cover {
            max-width: 350px; width: 100%;
            border: 10px solid #fff;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .hub-details h1 { font-family: var(--font-header); font-size: 4rem; margin-bottom: 0.5rem; }
        .hub-details .genre { color: var(--accent-color); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 2rem; }
        .hub-details .synopsis { max-width: 700px; margin: 0 auto 3rem auto; line-height: 1.8; font-size: 1.1rem; }
        
        .hub-actions { display: flex; justify-content: center; gap: 1rem; }
        .codex-button {
            padding: 1rem 2.5rem;
            background: transparent;
            border: 2px solid var(--text-color);
            color: var(--text-color);
            font-family: var(--font-header);
            font-size: 1rem; letter-spacing: 2px;
            cursor: pointer; transition: 0.3s;
        }
        .codex-button:hover { background: var(--text-color); color: var(--bg-color); }

        /* --- 6. READER --- */
        .reader-layout { display: grid; grid-template-columns: 250px 1fr; gap: 4rem; }
        .reader-sidebar h3 { font-family: var(--font-header); margin-bottom: 1rem; }
        .reader-sidebar ul { list-style: none; }
        .reader-sidebar li { padding: 0.8rem 0; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .reader-sidebar li:hover { color: var(--accent-color); }
        .reader-sidebar li.active { font-weight: bold; color: var(--accent-color); }
        .reader-content h2 { font-family: var(--font-header); font-size: 2.5rem; margin-bottom: 2rem; }
        .reader-content .text { font-size: 1.2rem; line-height: 2; }
        
        /* --- 7. GALLERY & CHARACTERS --- */
        .char-grid { display: flex; flex-wrap: wrap; gap: 2rem; justify-content: center; }
        .char-card {
            width: 250px; text-align: center; cursor: pointer;
            transition: transform 0.2s;
        }
        .char-card:hover { transform: translateY(-5px); }
        .char-card img {
            width: 100%; aspect-ratio: 3/4; object-fit: cover;
            border: 1px solid var(--border-color); margin-bottom: 1rem;
        }
        .char-card .name { font-family: var(--font-header); font-size: 1.5rem; }
        .char-card .role { color: var(--accent-color); text-transform: uppercase; font-size: 0.8rem; }

        .char-profile {
            display: grid; grid-template-columns: 300px 1fr; gap: 3rem;
            margin-bottom: 3rem; align-items: flex-start;
        }
        .profile-img { width: 100%; border: 1px solid var(--border-color); }
        .profile-name { font-family: var(--font-header); font-size: 3rem; }
        .profile-role { color: var(--accent-color); text-transform: uppercase; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .profile-bio { line-height: 1.8; white-space: pre-line; }

        .tag-row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 2rem; }
        .tag-chip { padding: 5px 15px; border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer; }
        .tag-chip.active, .tag-chip:hover { background: var(--text-color); color: var(--bg-color); border-color: var(--text-color); }

        .gallery-grid { column-count: 3; column-gap: 1.5rem; }
        .gallery-item { break-inside: avoid; margin-bottom: 1.5rem; }
        .gallery-item img { width: 100%; border: 1px solid var(--border-color); }

        /* Responsive */
        @media (max-width: 900px) {
            .reader-layout, .char-profile { grid-template-columns: 1fr; }
            .gallery-grid { column-count: 2; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header id="main-header">
            <div class="logo" onclick="Router.navigate('home')">CODEX</div>
            <div id="back-container"></div>
        </header>
        <main id="content-stage"></main>
    </div>

    <script>
        // --- STATE & API (Read-Only) ---
        const State = {
            manifest: [], currentStoryId: null, currentStoryConfig: null, currentChars: [],
            filterTag: 'All'
        };

        const API = {
            get: async (path) => (await fetch(path)).json()
        };

        // --- RENDERER (New "Codex" HTML Structures) ---
        const Render = {
            stage: document.getElementById('content-stage'),
            
            home: async () => {
                UI.setBackButton(null);
                State.manifest = await API.get('data/manifest.json');
                let html = '<ul class="codex-list">';
                State.manifest.forEach((story) => {
                    html += `
                        <li class="codex-list-item" onclick="Router.navigate('story/${story.id}')">
                            <img src="${story.cover}" class="item-illumination" alt="${story.title}">
                            <div class="item-details">
                                <h2>${story.title}</h2>
                                <p>${story.desc}</p>
                            </div>
                        </li>`;
                });
                Render.stage.innerHTML = html + '</ul>';
            },

            storyHub: async (id) => {
                UI.setBackButton("Router.navigate('home')", "← Table of Contents");
                State.currentStoryId = id;
                State.currentStoryConfig = await API.get(`data/stories/${id}/config.json`);
                State.manifest = await API.get('data/manifest.json');
                const storyInManifest = State.manifest.find(s => s.id === id) || { cover: "" };
                const conf = State.currentStoryConfig;
                
                Render.stage.innerHTML = `
                    <div class="codex-hub fade-in">
                        <img class="hub-cover" src="${storyInManifest.cover}" alt="Cover">
                        <div class="hub-details">
                            <div class="genre">${conf.genre}</div>
                            <h1>${conf.title}</h1>
                            <p class="synopsis">${conf.synopsis}</p>
                            <div class="hub-actions">
                                <button class="codex-button" onclick="Router.navigate('read/${id}')">Begin Reading</button>
                                <button class="codex-button" onclick="Router.navigate('gallery/${id}')">View Gallery</button>
                            </div>
                        </div>
                    </div>`;
            },

            reader: async (id, chapterIndex = 0) => {
                UI.setBackButton(`Router.navigate('story/${id}')`, `← Back to ${State.currentStoryConfig.title}`);
                const chapters = await API.get(`data/stories/${id}/chapters/index.json`);
                const chapter = chapters[chapterIndex];
                if (!chapter) { Router.navigate(`story/${id}`); return; }

                let sidebar = '';
                chapters.forEach((c, i) => {
                    sidebar += `<li class="${i == chapterIndex ? 'active':''}" onclick="Router.navigate('read/${id}/${i}')">${c.title}</li>`;
                });

                let nextButton = parseInt(chapterIndex) < chapters.length - 1 
                    ? `<button class="codex-button" onclick="Router.navigate('read/${id}/${parseInt(chapterIndex) + 1}')">Next Chapter</button>`
                    : '<span>End</span>';

                Render.stage.innerHTML = `
                    <div class="reader-layout fade-in">
                        <nav class="reader-sidebar">
                            <h3>Chapters</h3>
                            <ul>${sidebar}</ul>
                        </nav>
                        <article class="reader-content">
                            <h2>${chapter.title}</h2>
                            <div class="text">${chapter.content.replace(/\n/g, '<br>')}</div>
                            <div style="text-align:center; margin-top:3rem; padding-top:2rem; border-top:1px solid var(--border-color);">${nextButton}</div>
                        </article>
                    </div>`;
            },

            gallery: async (id, charId = null) => {
                UI.setBackButton(`Router.navigate('story/${id}')`, `← Back to Hub`);
                State.currentStoryId = id;
                State.currentChars = await API.get(`data/stories/${id}/gallery/manifest.json`);
                
                if (!charId) {
                    let html = '<div class="char-grid fade-in">';
                    State.currentChars.forEach((char) => {
                        html += `
                            <div class="char-card" onclick="Router.navigate('gallery/${id}/${char.id}')">
                                <img src="${char.img}" alt="${char.name}">
                                <div class="name">${char.name}</div>
                                <div class="role">${char.role || ""}</div>
                            </div>`;
                    });
                    Render.stage.innerHTML = html + '</div>';
                } else {
                    const charData = State.currentChars.find(c => c.id === charId);
                    if (!charData) { Router.navigate(`gallery/${id}`); return; }

                    const allTags = new Set(['All']);
                    if(charData.gallery_images) charData.gallery_images.forEach(img => img.tags.forEach(t => allTags.add(t)));
                    
                    let tagHtml = `<div class="tag-row">`;
                    allTags.forEach(tag => tagHtml += `<div class="tag-chip ${tag === State.filterTag ? 'active' : ''}" onclick="Actions.setFilter('${tag}')">${tag}</div>`);
                    tagHtml += `</div>`;

                    let html = `
                        <div class="fade-in">
                            <div class="char-profile">
                                <img src="${charData.img}" class="profile-img" alt="${charData.name}">
                                <div class="profile-details">
                                    <div class="profile-name">${charData.name}</div>
                                    <div class="profile-role">${charData.role || ""}</div>
                                    <p class="profile-bio">${charData.bio || ""}</p>
                                </div>
                            </div>
                            ${tagHtml}
                            <div class="gallery-grid" id="gallery-grid"></div>
                        </div>`;
                    Render.stage.innerHTML = html;
                    Actions.renderGalleryGrid();
                }
            }
        };

        // --- ACTIONS & UI ---
        const Actions = {
            renderGalleryGrid: () => {
                const charData = State.currentChars.find(c => c.id === Router.getParts()[2]);
                if(!charData || !charData.gallery_images) return;
                
                let images = charData.gallery_images;
                if(State.filterTag !== 'All') images = images.filter(img => img.tags.includes(State.filterTag));
                
                const grid = document.getElementById('gallery-grid');
                grid.innerHTML = images.map(img => `<div class="gallery-item"><img src="${img.src}" loading="lazy"></div>`).join('');
            },
            setFilter: (tag) => { State.filterTag = tag; Actions.renderGalleryGrid(); },
        };

        const UI = {
            backContainer: document.getElementById('back-container'),
            setBackButton: (action, label) => {
                UI.backContainer.innerHTML = action ? `<div class="back-btn-wrapper" onclick="${action}">${label}</div>` : '';
            }
        };

        // --- ROUTER ---
        const Router = {
            getParts: () => (window.location.hash.slice(1) || 'home').split('/'),
            navigate: (hash) => { window.location.hash = hash; },
            handle: () => {
                const parts = Router.getParts();
                const view = parts[0];
                if (view === 'home') Render.home();
                else if (view === 'story') Render.storyHub(parts[1]);
                else if (view === 'read') Render.reader(parts[1], parts[2]);
                else if (view === 'gallery') Render.gallery(parts[1], parts[2]);
            }
        };

        window.addEventListener('hashchange', Router.handle);
        window.addEventListener('DOMContentLoaded', Router.handle);
    </script>
</body>
</html>
