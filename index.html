<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Aether Archives | Obsidian Edition</title>
    
    <!-- New Font Stack: Playfair Display (Elegant) + Inter (Clean) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. DESIGN TOKENS --- */
        :root {
            --bg-deep: #050505;
            --bg-panel: #111111;
            --border-color: #333333;
            --accent-color: #e0e0e0; /* Platinum */
            --highlight: #ff4d4d; /* Subtle red interaction hint */
            
            --text-main: #f4f4f4;
            --text-muted: #888888;
            
            --font-display: 'Playfair Display', serif;
            --font-ui: 'Inter', sans-serif;
            
            --gap-std: 2rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow-x: hidden;
            height: 100vh;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        /* --- 2. LAYOUT UTILITIES --- */
        #app-container {
            width: 100%; min-height: 100vh;
            display: flex; flex-direction: column;
            transition: opacity 0.5s ease;
        }

        .fade-in { animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 3. NAVIGATION (Minimalist Top Bar) --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 2rem 4rem; z-index: 50;
            position: fixed; top: 0; left: 0; width: 100%;
            background: linear-gradient(to bottom, rgba(5,5,5,0.9), transparent);
            pointer-events: none; /* Let clicks pass through empty space */
        }
        nav > * { pointer-events: auto; }

        .logo {
            font-family: var(--font-display); font-size: 1.5rem; font-weight: 700; letter-spacing: 2px;
            color: var(--text-main); text-transform: uppercase; cursor: pointer;
            mix-blend-mode: difference; /* Ensures visibility over light images */
        }

        .nav-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-main); padding: 0.5rem 1.5rem; border-radius: 50px;
            cursor: pointer; transition: 0.3s; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;
        }
        .nav-btn:hover { background: var(--text-main); color: var(--bg-deep); border-color: var(--text-main); }

        /* --- 4. VIEW: HOME (Editorial Grid) --- */
        .home-container {
            padding: 8rem 4rem 4rem;
            max-width: 1600px; margin: 0 auto; width: 100%;
        }
        .archive-header {
            font-family: var(--font-display); font-size: 4vw; margin-bottom: 4rem;
            border-bottom: 1px solid var(--border-color); padding-bottom: 2rem;
        }

        .story-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2px; /* Tight fit */
            background: var(--border-color); /* Creates the grid lines */
            border: 1px solid var(--border-color);
        }

        .story-card {
            background: var(--bg-panel); aspect-ratio: 3/4; position: relative;
            overflow: hidden; cursor: pointer; group;
        }
        
        .story-card img {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1), filter 0.5s;
            filter: grayscale(100%) contrast(120%);
        }
        
        .story-card:hover img { transform: scale(1.05); filter: grayscale(0%) contrast(100%); }

        .card-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 2rem;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            transform: translateY(20px); opacity: 0; transition: 0.4s;
        }
        .story-card:hover .card-overlay { transform: translateY(0); opacity: 1; }

        .card-title { font-family: var(--font-display); font-size: 1.8rem; margin-bottom: 0.5rem; }
        .card-desc { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; }

        /* --- 5. VIEW: STORY HUB (Split Screen) --- */
        .split-layout {
            display: flex; height: 100vh; width: 100vw; overflow: hidden;
        }
        
        .split-image {
            width: 40%; height: 100%; position: relative;
            border-right: 1px solid var(--border-color);
        }
        .split-image img { width: 100%; height: 100%; object-fit: cover; }
        
        .split-content {
            width: 60%; height: 100%; overflow-y: auto;
            padding: 6rem 6rem; background: var(--bg-deep);
        }

        .hub-meta { 
            font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; 
            color: var(--text-muted); margin-bottom: 1rem; border-left: 2px solid var(--accent-color); 
            padding-left: 1rem;
        }
        .hub-title { font-family: var(--font-display); font-size: 5rem; line-height: 0.9; margin-bottom: 2rem; }
        .hub-synopsis { 
            font-size: 1.2rem; line-height: 1.8; color: #ccc; margin-bottom: 4rem; 
            max-width: 700px;
        }

        .action-row { display: flex; gap: 1rem; padding-bottom: 4rem; border-bottom: 1px solid var(--border-color); margin-bottom: 4rem; }
        
        .big-btn {
            padding: 1.5rem 3rem; font-family: var(--font-display); font-size: 1.2rem;
            background: var(--text-main); color: var(--bg-deep); border: none;
            cursor: pointer; transition: 0.3s;
        }
        .big-btn:hover { background: var(--accent-color); transform: translateY(-2px); }
        .big-btn.outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); }
        .big-btn.outline:hover { border-color: var(--text-main); }

        /* --- 6. VIEW: READER (Focus Mode) --- */
        .reader-container {
            max-width: 800px; margin: 8rem auto 4rem; padding: 0 2rem;
        }
        .chapter-header { text-align: center; margin-bottom: 4rem; }
        .chapter-title { font-family: var(--font-display); font-size: 3rem; margin-bottom: 1rem; }
        .chapter-nav { display: flex; justify-content: center; gap: 2rem; margin-bottom: 2rem; }
        
        .chapter-text {
            font-family: var(--font-body); font-size: 1.3rem; line-height: 1.9; color: #dcdcdc;
            text-align: justify;
        }
        .chapter-text p { margin-bottom: 1.5rem; }

        /* Drawer for Chapter List */
        .chapter-drawer {
            position: fixed; left: 0; top: 0; height: 100%; width: 300px;
            background: var(--bg-panel); border-right: 1px solid var(--border-color);
            transform: translateX(-100%); transition: 0.4s cubic-bezier(0.8, 0, 0.2, 1);
            z-index: 100; padding: 6rem 2rem; overflow-y: auto;
        }
        .chapter-drawer.open { transform: translateX(0); }
        .drawer-toggle { position: fixed; top: 50%; left: 0; padding: 1rem; cursor: pointer; z-index: 101; opacity: 0.5; transition: 0.3s; }
        .drawer-toggle:hover { opacity: 1; }

        /* --- 7. VIEW: GALLERY (Masonry & Hero) --- */
        .gallery-container { padding: 6rem 4rem; }
        
        .char-hero {
            display: grid; grid-template-columns: 1fr 1fr; gap: 4rem;
            margin-bottom: 6rem; align-items: center; min-height: 70vh;
        }
        
        .char-portrait {
            width: 100%; height: 80vh; object-fit: cover; 
            border: 1px solid var(--border-color);
        }
        
        .char-details h1 { font-family: var(--font-display); font-size: 6rem; line-height: 0.9; margin-bottom: 0.5rem; }
        .char-details h3 { font-family: var(--font-ui); font-weight: 300; letter-spacing: 3px; color: var(--accent-color); margin-bottom: 2rem; text-transform: uppercase;}
        .char-details p { font-size: 1.1rem; line-height: 1.7; color: #999; margin-bottom: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem;}

        .filter-bar {
            display: flex; gap: 2rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;
            font-family: var(--font-display); font-style: italic;
        }
        .filter-item { cursor: pointer; opacity: 0.5; transition: 0.3s; }
        .filter-item.active, .filter-item:hover { opacity: 1; color: var(--accent-color); }

        .masonry-grid {
            column-count: 4; column-gap: 1rem;
        }
        .masonry-item {
            break-inside: avoid; margin-bottom: 1rem;
            position: relative; overflow: hidden;
        }
        .masonry-item img { width: 100%; display: block; transition: 0.5s; filter: grayscale(50%); }
        .masonry-item:hover img { filter: grayscale(0%); transform: scale(1.03); }

        /* --- 8. ROSTER GRID (Minimalist) --- */
        .roster-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 2rem; padding: 2rem;
        }
        .roster-card { cursor: pointer; text-align: center; opacity: 0.7; transition: 0.3s; }
        .roster-card:hover { opacity: 1; transform: translateY(-5px); }
        .roster-img { width: 100%; aspect-ratio: 3/4; object-fit: cover; margin-bottom: 1rem; border: 1px solid #333;}
        .roster-name { font-family: var(--font-display); font-size: 1.2rem; }

        /* Mobile Adjustments */
        @media (max-width: 900px) {
            .split-layout { flex-direction: column; height: auto; }
            .split-image { width: 100%; height: 50vh; }
            .split-content { width: 100%; padding: 2rem; }
            .char-hero { grid-template-columns: 1fr; }
            .masonry-grid { column-count: 2; }
            .hub-title { font-size: 3rem; }
            nav { padding: 1rem 2rem; }
            .home-container { padding: 6rem 1rem; }
        }
    </style>
</head>
<body>

    <nav id="navbar">
        <div id="back-slot"></div>
        <div class="logo" onclick="Router.navigate('home')">ARCHIVE.OS</div>
        <div id="theme-slot" style="width: 50px;"></div>
    </nav>

    <!-- Drawer for Reader -->
    <div id="chapter-drawer" class="chapter-drawer">
        <h3 style="margin-bottom:2rem; font-family:var(--font-display);">Index</h3>
        <div id="drawer-content"></div>
    </div>
    <div id="drawer-toggle" class="drawer-toggle" style="display:none;" onclick="UI.toggleDrawer()">
        <i class="fas fa-bars fa-2x" style="color:#555"></i>
    </div>

    <div id="app-container">
        <!-- Content injected here -->
    </div>

    <script>
        // --- LOGIC ---
        // (Almost identical to previous logic, but adapted for new class names/layout)

        const API = { get: async (path) => (await fetch(path)).json() };

        const State = {
            manifest: [], currentStory: null, currentChars: [], filterTag: 'All', wallpaperChar: null
        };

        const Render = {
            stage: document.getElementById('app-container'),

            home: async () => {
                UI.resetLayout();
                State.manifest = await API.get('data/manifest.json');
                
                let html = `
                <div class="home-container fade-in">
                    <h1 class="archive-header">Selected Works</h1>
                    <div class="story-grid">`;
                
                State.manifest.forEach(s => {
                    html += `
                        <div class="story-card" onclick="Router.navigate('story/${s.id}')">
                            <img src="${s.cover}">
                            <div class="card-overlay">
                                <div class="card-title">${s.title}</div>
                                <div class="card-desc">${s.desc}</div>
                            </div>
                        </div>`;
                });
                
                html += `</div></div>`;
                Render.stage.innerHTML = html;
            },

            storyHub: async (id) => {
                UI.resetLayout();
                UI.setBack("Router.navigate('home')", "Index");
                
                const config = await API.get(`data/stories/${id}/config.json`);
                State.manifest = await API.get('data/manifest.json');
                State.currentChars = await API.get(`data/stories/${id}/gallery/manifest.json`).catch(()=>[]);
                
                const cover = State.manifest.find(s=>s.id === id).cover;
                
                // Wallpaper Logic
                const wpChar = State.currentChars.find(c => c.name.toLowerCase().includes('wallpaper'));
                if(wpChar) UI.setThemeBtn(wpChar);

                Render.stage.innerHTML = `
                    <div class="split-layout fade-in">
                        <div class="split-image">
                            <img src="${cover}">
                        </div>
                        <div class="split-content">
                            <div class="hub-meta">${config.status}  //  ${config.genre}</div>
                            <h1 class="hub-title">${config.title}</h1>
                            <p class="hub-synopsis">${config.synopsis}</p>
                            
                            <div class="action-row">
                                <button class="big-btn" onclick="Router.navigate('read/${id}')">Read Now</button>
                                <button class="big-btn outline" onclick="Router.navigate('gallery/${id}')">Visual Archives</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            reader: async (id, idx = 0) => {
                UI.resetLayout();
                UI.setBack(`Router.navigate('story/${id}')`, "Return");
                
                const chapters = await API.get(`data/stories/${id}/chapters/index.json`);
                const chapter = chapters[idx];
                
                // Setup Drawer
                const drawer = document.getElementById('drawer-content');
                document.getElementById('drawer-toggle').style.display = 'block';
                drawer.innerHTML = chapters.map((c, i) => 
                    `<div style="padding:10px 0; cursor:pointer; color:${i==idx?'#fff':'#666'};" onclick="Router.navigate('read/${id}/${i}')">${i+1}. ${c.title}</div>`
                ).join('');

                let nextBtn = idx < chapters.length - 1 
                    ? `<button class="big-btn outline" style="margin-top:4rem;" onclick="Router.navigate('read/${id}/${parseInt(idx)+1}')">Next Chapter</button>`
                    : `<div style="margin-top:4rem; color:#666;">End of Record</div>`;

                Render.stage.innerHTML = `
                    <div class="reader-container fade-in">
                        <div class="chapter-header">
                            <div style="font-family:var(--font-ui); color:#666; margin-bottom:1rem;">CHAPTER ${parseInt(idx)+1}</div>
                            <h1 class="chapter-title">${chapter.title}</h1>
                        </div>
                        <div class="chapter-text">
                            ${chapter.content.replace(/\n/g, '<br>')}
                        </div>
                        <div style="text-align:center;">${nextBtn}</div>
                    </div>
                `;
            },

            gallery: async (id, charId = null) => {
                UI.resetLayout();
                State.currentChars = await API.get(`data/stories/${id}/gallery/manifest.json`);
                
                if(!charId) {
                    // Roster View
                    UI.setBack(`Router.navigate('story/${id}')`, "Overview");
                    let html = `<div class="home-container fade-in"><h1 class="archive-header">Dramatis Personae</h1><div class="roster-grid">`;
                    State.currentChars.forEach(c => {
                        html += `
                            <div class="roster-card" onclick="Router.navigate('gallery/${id}/${c.id}')">
                                <img class="roster-img" src="${c.img}">
                                <div class="roster-name">${c.name}</div>
                            </div>`;
                    });
                    Render.stage.innerHTML = html + `</div></div>`;
                } else {
                    // Detail View
                    UI.setBack(`Router.navigate('gallery/${id}')`, "Roster");
                    const char = State.currentChars.find(c => c.id === charId);
                    
                    // Tags
                    const allTags = new Set(['All']);
                    if(char.gallery_images) char.gallery_images.forEach(img => img.tags.forEach(t => allTags.add(t)));
                    
                    let tagsHtml = `<div class="filter-bar">`;
                    allTags.forEach(t => tagsHtml += `<div class="filter-item ${t==='All'?'active':''}" onclick="Actions.filter('${t}')">${t}</div>`);
                    tagsHtml += `</div>`;

                    Render.stage.innerHTML = `
                        <div class="gallery-container fade-in">
                            <div class="char-hero">
                                <img class="char-portrait" src="${char.img}">
                                <div class="char-details">
                                    <h1>${char.name}</h1>
                                    <h3>${char.role || "Unknown"}</h3>
                                    <p>${char.bio || "No data available."}</p>
                                </div>
                            </div>
                            ${tagsHtml}
                            <div class="masonry-grid" id="masonry-grid"></div>
                        </div>
                    `;
                    Actions.renderGrid(char.gallery_images, 'All');
                }
            }
        };

        const Actions = {
            filter: (tag) => {
                // Update active class
                document.querySelectorAll('.filter-item').forEach(el => {
                    el.classList.toggle('active', el.innerText === tag);
                });
                
                const charId = window.location.hash.split('/')[2];
                const char = State.currentChars.find(c => c.id === charId);
                Actions.renderGrid(char.gallery_images, tag);
            },
            
            renderGrid: (images, tag) => {
                if(!images) return;
                let filtered = tag === 'All' ? images : images.filter(img => img.tags.includes(tag));
                
                // Sort Safe first logic
                if(tag === 'All') {
                     const nsfw = ['NSFW', 'R-18', 'Explicit'];
                     filtered.sort((a,b) => {
                         const aBad = a.tags.some(t=>nsfw.includes(t));
                         const bBad = b.tags.some(t=>nsfw.includes(t));
                         return aBad - bBad;
                     });
                }

                document.getElementById('masonry-grid').innerHTML = filtered.map(img => 
                    `<div class="masonry-item"><img src="${img.src}"></div>`
                ).join('');
            }
        };

        const UI = {
            backSlot: document.getElementById('back-slot'),
            themeSlot: document.getElementById('theme-slot'),
            
            resetLayout: () => {
                document.getElementById('drawer-toggle').style.display = 'none';
                document.getElementById('chapter-drawer').classList.remove('open');
                UI.backSlot.innerHTML = '';
                UI.themeSlot.innerHTML = '';
            },
            
            setBack: (action, label) => {
                UI.backSlot.innerHTML = `<button class="nav-btn" onclick="${action}">&larr; ${label}</button>`;
            },

            setThemeBtn: (char) => {
                UI.themeSlot.innerHTML = `<button class="nav-btn" onclick="UI.changeBg('${char.gallery_images[0].src}')">Theme</button>`;
                // Simple logic: clicking toggles bg change (for demo, just picks first img)
                // You can expand this to the full modal logic from previous version if desired.
            },
            
            toggleDrawer: () => document.getElementById('chapter-drawer').classList.toggle('open'),
            
            // Idle Mode
            initIdle: () => {
                const nav = document.getElementById('navbar');
                window.addEventListener('mousemove', (e) => {
                    const margin = 0.05; 
                    const isEdge = (e.clientX < window.innerWidth * margin) || (e.clientX > window.innerWidth * (1 - margin));
                    
                    if(isEdge) {
                        document.body.style.cursor = 'none';
                        nav.style.opacity = '0';
                        Render.stage.style.opacity = '0';
                    } else {
                        document.body.style.cursor = 'default';
                        nav.style.opacity = '1';
                        Render.stage.style.opacity = '1';
                    }
                });
            },
            
            changeBg: (src) => {
                document.body.style.backgroundImage = `url('${src}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
                // Darken overlay
                document.body.style.boxShadow = 'inset 0 0 0 2000px rgba(5,5,5,0.85)'; 
            }
        };

        const Router = {
            navigate: (hash) => window.location.hash = hash,
            handle: () => {
                const parts = (window.location.hash.slice(1) || 'home').split('/');
                const view = parts[0];
                if(view === 'home') Render.home();
                else if(view === 'story') Render.storyHub(parts[1]);
                else if(view === 'read') Render.reader(parts[1], parts[2]);
                else if(view === 'gallery') Render.gallery(parts[1], parts[2]);
            }
        };

        window.addEventListener('hashchange', Router.handle);
        window.addEventListener('DOMContentLoaded', () => {
            Router.handle();
            UI.initIdle();
        });

    </script>
</body>
</html>
