<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AETHER | NOIR EDITORIAL</title>
    
    <!-- New Fonts: Playfair Display (Elegant Serif) & Lato (Clean Sans) -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. THE NOIR THEME VARIABLES --- */
        :root {
            --bg-color: #080808;
            --text-color: #e0e0e0;
            --accent-color: #d4af37; /* Metallic Gold */
            --subtle-border: rgba(255, 255, 255, 0.1);
            --font-header: 'Playfair Display', serif;
            --font-body: 'Lato', sans-serif;
            --sidebar-width: 60px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-body);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
        }

        /* --- 2. LAYOUT SKELETON --- */
        
        /* The Background Layer (Full Screen, dimmed) */
        #global-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            z-index: -1; opacity: 0.2; /* Darker, more subtle */
            transition: background-image 0.8s ease-in-out, opacity 0.5s ease;
            filter: grayscale(100%) contrast(1.2); /* Artistic noir filter */
        }

        /* Minimal Sidebar Navigation */
        #side-nav {
            width: var(--sidebar-width); height: 100%;
            border-right: 1px solid var(--subtle-border);
            display: flex; flex-direction: column; align-items: center; padding-top: 2rem;
            background: rgba(8, 8, 8, 0.9); z-index: 50;
            transition: width 0.3s ease;
        }
        .nav-icon {
            font-size: 1.2rem; margin-bottom: 2rem; color: #555; cursor: pointer;
            transition: 0.3s;
        }
        .nav-icon:hover { color: var(--accent-color); }
        .logo-vertical {
            writing-mode: vertical-rl; text-orientation: mixed;
            font-family: var(--font-header); letter-spacing: 5px; font-weight: 700;
            margin-top: auto; margin-bottom: 2rem; color: var(--accent-color); opacity: 0.5;
        }

        /* Main Content Stage */
        #content-stage {
            flex: 1; height: 100%; overflow: hidden; position: relative;
        }

        /* Utilities */
        .fade-in { animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }

        /* --- 3. VIEW: HOME (The Hero List) --- */
        .home-layout {
            height: 100%; display: flex; align-items: center; padding-left: 10vw;
        }
        .story-list {
            display: flex; flex-direction: column; gap: 0; border-left: 1px solid var(--subtle-border);
        }
        .story-list-item {
            padding: 1.5rem 3rem;
            font-family: var(--font-header); font-size: 3rem; color: #444;
            cursor: pointer; transition: 0.4s; position: relative;
            line-height: 1;
        }
        .story-list-item:hover {
            color: #fff; padding-left: 4rem;
        }
        .story-list-item.active { color: #fff; padding-left: 4rem; }
        .story-list-item::before {
            content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            width: 0px; height: 1px; background: var(--accent-color); transition: 0.4s;
        }
        .story-list-item:hover::before { width: 30px; }
        
        .story-meta {
            font-family: var(--font-body); font-size: 0.9rem; color: var(--accent-color);
            text-transform: uppercase; letter-spacing: 2px; margin-top: 5px;
            opacity: 0; transform: translateY(10px); transition: 0.3s; height: 0;
        }
        .story-list-item:hover .story-meta { opacity: 1; transform: translateY(0); height: auto; }

        /* --- 4. VIEW: STORY HUB (Split Screen) --- */
        .split-layout {
            display: flex; width: 100%; height: 100%;
        }
        .split-left {
            width: 45%; height: 100%;
            background-size: cover; background-position: center;
            position: relative; border-right: 1px solid var(--subtle-border);
        }
        .split-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,1), transparent);
        }
        .split-right {
            width: 55%; height: 100%; overflow-y: auto; padding: 5rem;
            background: var(--bg-color);
        }
        
        .huge-title { font-family: var(--font-header); font-size: 4rem; line-height: 0.9; margin-bottom: 2rem; color: #fff; }
        .meta-tag { display: inline-block; padding: 5px 15px; border: 1px solid var(--subtle-border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; margin-right: 10px; margin-bottom: 2rem; color: var(--accent-color); }
        .synopsis-text { font-size: 1.2rem; line-height: 1.8; color: #aaa; margin-bottom: 3rem; max-width: 600px; }
        
        .action-btn {
            background: transparent; border: 1px solid #fff; color: #fff;
            padding: 1rem 3rem; font-family: var(--font-body); text-transform: uppercase;
            letter-spacing: 2px; cursor: pointer; transition: 0.3s; font-size: 0.8rem;
            margin-right: 1rem;
        }
        .action-btn:hover { background: #fff; color: #000; }
        .action-btn.secondary { border-color: var(--subtle-border); color: #888; }
        .action-btn.secondary:hover { border-color: var(--accent-color); color: var(--accent-color); background: transparent; }

        /* --- 5. VIEW: READER (Minimalist) --- */
        .reader-container {
            max-width: 800px; margin: 0 auto; height: 100%;
            display: flex; flex-direction: column;
            border-left: 1px solid var(--subtle-border); border-right: 1px solid var(--subtle-border);
            background: #0b0b0b;
        }
        .reader-nav {
            padding: 1.5rem; border-bottom: 1px solid var(--subtle-border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .chapter-title { font-family: var(--font-header); font-size: 1.5rem; color: var(--accent-color); }
        .reader-text-area {
            flex: 1; overflow-y: auto; padding: 4rem 5rem;
            font-family: var(--font-header); font-size: 1.3rem; line-height: 1.8; color: #d0d0d0;
        }
        .reader-text-area p { margin-bottom: 1.5rem; }

        /* --- 6. VIEW: GALLERY (Masonry Grid) --- */
        .gallery-container { padding: 4rem; height: 100%; overflow-y: auto; }
        .gallery-header { 
            display: flex; justify-content: space-between; align-items: flex-end; 
            margin-bottom: 3rem; border-bottom: 1px solid var(--subtle-border); padding-bottom: 2rem; 
        }
        .masonry-grid { column-count: 4; column-gap: 1.5rem; }
        .masonry-item {
            break-inside: avoid; margin-bottom: 1.5rem; position: relative;
            transition: transform 0.3s ease; cursor: zoom-in;
        }
        .masonry-item:hover { transform: translateY(-5px); z-index: 10; }
        .masonry-item img { width: 100%; display: block; filter: grayscale(50%); transition: 0.5s; }
        .masonry-item:hover img { filter: grayscale(0%); }
        
        .char-tag {
            position: absolute; bottom: 10px; left: 10px;
            background: #000; color: #fff; padding: 3px 10px; font-size: 0.7rem;
            text-transform: uppercase; letter-spacing: 1px; opacity: 0; transition: 0.3s;
        }
        .masonry-item:hover .char-tag { opacity: 1; }

        /* Character Profile in Gallery */
        .char-profile-split {
            display: flex; height: 400px; margin-bottom: 4rem;
            border: 1px solid var(--subtle-border);
        }
        .cp-img { width: 300px; height: 100%; object-fit: cover; filter: grayscale(30%); }
        .cp-info { padding: 3rem; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .cp-name { font-family: var(--font-header); font-size: 3rem; line-height: 1; margin-bottom: 0.5rem; }
        .cp-role { color: var(--accent-color); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 2rem; font-size: 0.8rem; }
        .cp-bio { color: #888; line-height: 1.6; max-width: 500px; }

        /* Wallpaper Modal */
        .wp-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .wp-grid { display: flex; gap: 10px; overflow-x: auto; max-width: 90%; padding: 20px 0; }
        .wp-item { height: 200px; cursor: pointer; border: 1px solid #333; opacity: 0.7; transition: 0.3s; }
        .wp-item:hover { opacity: 1; border-color: var(--accent-color); transform: scale(1.05); }

        /* Mobile */
        @media (max-width: 900px) {
            .split-layout { flex-direction: column; }
            .split-left { width: 100%; height: 40vh; }
            .split-right { width: 100%; height: 60vh; padding: 2rem; }
            .masonry-grid { column-count: 2; }
            .reader-container { border: none; }
            .reader-text-area { padding: 2rem; }
            .char-profile-split { flex-direction: column; height: auto; }
            .cp-img { width: 100%; height: 300px; }
            .home-layout { padding-left: 1rem; }
            .story-list-item { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <div id="global-bg"></div>

    <!-- Minimal Side Nav -->
    <nav id="side-nav">
        <div class="nav-icon" onclick="Router.navigate('home')"><i class="fas fa-home"></i></div>
        <div class="nav-icon" id="back-btn" style="opacity:0"><i class="fas fa-arrow-left"></i></div>
        <div class="nav-icon" id="wp-btn" style="display:none" onclick="UI.openWallpaperModal()"><i class="fas fa-palette"></i></div>
        <div class="logo-vertical">AETHER</div>
    </nav>

    <div id="content-stage">
        <!-- Content Injected Here -->
    </div>

    <!-- Wallpaper Modal -->
    <div id="wp-modal" class="wp-modal">
        <h2 style="font-family: var(--font-header); color:#fff; margin-bottom:2rem;">Select Atmosphere</h2>
        <div id="wp-grid" class="wp-grid"></div>
        <div style="margin-top:2rem; cursor:pointer; color:#666;" onclick="document.getElementById('wp-modal').style.display='none'">CLOSE</div>
    </div>

    <script>
        // --- 1. CORE LOGIC (READ ONLY) ---
        const State = {
            manifest: [], currentStoryId: null, currentStoryConfig: null, currentChars: [], wallpaperChar: null
        };

        const API = { get: async (path) => (await fetch(path)).json() };

        // --- 2. RENDERER (NOIR STYLE) ---
        const Render = {
            stage: document.getElementById('content-stage'),

            home: async () => {
                UI.resetState();
                State.manifest = await API.get('data/manifest.json');
                const settings = await API.get('data/settings.json').catch(() => ({}));
                UI.setBg(settings.homeBg || null);
                UI.setBackBtn(null);

                let listHtml = '';
                State.manifest.forEach(story => {
                    // Note: Hover changes BG instantly
                    listHtml += `
                        <div class="story-list-item fade-in" 
                             onmouseenter="UI.setBg('${story.cover}')" 
                             onclick="Router.navigate('story/${story.id}')">
                            ${story.title}
                            <div class="story-meta">${story.genre}</div>
                        </div>
                    `;
                });

                Render.stage.innerHTML = `
                    <div class="home-layout">
                        <div class="story-list">
                            ${listHtml}
                        </div>
                    </div>
                `;
            },

            storyHub: async (id) => {
                UI.resetState();
                State.currentStoryId = id;
                State.currentStoryConfig = await API.get(`data/stories/${id}/config.json`);
                State.currentChars = await API.get(`data/stories/${id}/gallery/manifest.json`).catch(()=>[]);
                
                UI.setBg(null); // Clear global BG, we use local split
                UI.setBackBtn("Router.navigate('home')");
                UI.checkWallpaperChar();

                const conf = State.currentStoryConfig;

                Render.stage.innerHTML = `
                    <div class="split-layout fade-in">
                        <div class="split-left" style="background-image: url('${conf.bg}')">
                            <div class="split-overlay"></div>
                        </div>
                        <div class="split-right">
                            <div class="meta-tag">${conf.status} â€¢ ${conf.genre}</div>
                            <div class="huge-title">${conf.title}</div>
                            <div class="synopsis-text">${conf.synopsis}</div>
                            
                            <div style="display:flex;">
                                <button class="action-btn" onclick="Router.navigate('read/${id}')">Read Story</button>
                                <button class="action-btn secondary" onclick="Router.navigate('gallery/${id}')">Gallery</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            reader: async (id, chapterIndex = 0) => {
                const chapters = await API.get(`data/stories/${id}/chapters/index.json`);
                UI.setBg(null); 
                document.getElementById('global-bg').style.opacity = '0'; // Go pitch black for reading
                UI.setBackBtn(`Router.navigate('story/${id}')`);

                const chapter = chapters[chapterIndex];
                if(!chapter) return;

                // Simple Nav
                const prev = parseInt(chapterIndex) > 0 ? `Router.navigate('read/${id}/${parseInt(chapterIndex)-1}')` : null;
                const next = parseInt(chapterIndex) < chapters.length-1 ? `Router.navigate('read/${id}/${parseInt(chapterIndex)+1}')` : null;

                Render.stage.innerHTML = `
                    <div class="reader-container fade-in">
                        <div class="reader-nav">
                            <div class="chapter-title">${chapter.title}</div>
                            <div style="color:#666; font-size:0.9rem;">${parseInt(chapterIndex)+1} / ${chapters.length}</div>
                        </div>
                        <div class="reader-text-area">
                            ${chapter.content.replace(/\n/g, '<br>')}
                            
                            <div style="margin-top:4rem; display:flex; justify-content:space-between; border-top:1px solid #333; padding-top:2rem;">
                                ${prev ? `<button class="action-btn secondary" onclick="${prev}">Previous</button>` : '<div></div>'}
                                ${next ? `<button class="action-btn" onclick="${next}">Next</button>` : '<div style="color:#666">End</div>'}
                            </div>
                        </div>
                    </div>
                `;
            },

            gallery: async (id, charId = null) => {
                UI.resetState();
                State.currentStoryId = id;
                const conf = await API.get(`data/stories/${id}/config.json`);
                // Use story BG but dimmed
                UI.setBg(conf.bg); 
                document.getElementById('global-bg').style.opacity = '0.1'; 
                
                State.currentChars = await API.get(`data/stories/${id}/gallery/manifest.json`);
                UI.checkWallpaperChar();

                if(!charId) {
                    // ROSTER (Using Masonry for visual interest)
                    UI.setBackBtn(`Router.navigate('story/${id}')`);
                    
                    let html = `<div class="gallery-container fade-in"><div class="gallery-header"><h1 class="huge-title" style="font-size:3rem; margin:0">Dramatis Personae</h1></div><div class="masonry-grid">`;
                    State.currentChars.forEach(char => {
                         html += `
                            <div class="masonry-item" onclick="Router.navigate('gallery/${id}/${char.id}')">
                                <img src="${char.img}">
                                <div class="char-tag">${char.name}</div>
                            </div>
                         `;
                    });
                    Render.stage.innerHTML = html + '</div></div>';
                } else {
                    // CHARACTER DETAILS + GALLERY
                    UI.setBackBtn(`Router.navigate('gallery/${id}')`);
                    const char = State.currentChars.find(c => c.id === charId);
                    
                    // Profile Header
                    let html = `
                        <div class="gallery-container fade-in">
                            <div class="char-profile-split">
                                <img class="cp-img" src="${char.img}">
                                <div class="cp-info">
                                    <div class="cp-name">${char.name}</div>
                                    <div class="cp-role">${char.role || "Unknown"}</div>
                                    <div class="cp-bio">${char.bio || "No biography available."}</div>
                                </div>
                            </div>
                            <div class="masonry-grid">
                    `;
                    
                    // Images
                    if(char.gallery_images) {
                        char.gallery_images.forEach(img => {
                            html += `<div class="masonry-item"><img src="${img.src}"></div>`;
                        });
                    }
                    
                    Render.stage.innerHTML = html + '</div></div>';
                }
            }
        };

        // --- 3. UI UTILITIES ---
        const UI = {
            bg: document.getElementById('global-bg'),
            wpBtn: document.getElementById('wp-btn'),
            backBtn: document.getElementById('back-btn'),
            
            resetState: () => {
                UI.bg.style.opacity = '0.3';
                UI.bg.style.filter = 'grayscale(100%) contrast(1.2)';
            },

            setBg: (url) => { 
                if(url) UI.bg.style.backgroundImage = `url('${url}')`; 
            },

            setBackBtn: (action) => {
                if(action) {
                    UI.backBtn.style.opacity = '1';
                    UI.backBtn.onclick = () => eval(action);
                } else {
                    UI.backBtn.style.opacity = '0';
                    UI.backBtn.onclick = null;
                }
            },

            checkWallpaperChar: () => {
                const wpChar = State.currentChars.find(c => c.name.toLowerCase().includes('wallpaper'));
                State.wallpaperChar = wpChar;
                UI.wpBtn.style.display = wpChar ? 'block' : 'none';
            },

            openWallpaperModal: () => {
                const grid = document.getElementById('wp-grid');
                grid.innerHTML = State.wallpaperChar.gallery_images.map(img => `
                    <div class="wp-item" onclick="UI.applyTheme('${img.src}')">
                        <img src="${img.src}">
                    </div>
                `).join('');
                document.getElementById('wp-modal').style.display = 'flex';
            },

            applyTheme: (url) => {
                UI.bg.style.backgroundImage = `url('${url}')`;
                UI.bg.style.opacity = '0.6'; // Brighter for selected wallpapers
                UI.bg.style.filter = 'grayscale(20%) contrast(1.1)'; // Less noir filter
                document.getElementById('wp-modal').style.display = 'none';
            }
        };

        // --- 4. ROUTER ---
        const Router = {
            navigate: (hash) => window.location.hash = hash,
            handle: () => {
                const parts = (window.location.hash.slice(1) || 'home').split('/');
                const view = parts[0];
                if (view === 'home') Render.home();
                else if (view === 'story') Render.storyHub(parts[1]);
                else if (view === 'read') Render.reader(parts[1], parts[2]);
                else if (view === 'gallery') Render.gallery(parts[1], parts[2]);
            }
        };

        window.addEventListener('hashchange', Router.handle);
        window.addEventListener('DOMContentLoaded', Router.handle);
    </script>
</body>
</html>
