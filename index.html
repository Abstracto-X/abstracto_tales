<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Aether Archives</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary-color: #ffffff;
            --accent-color: #ffd700;
            --glass-bg: rgba(15, 15, 15, 0.60); 
            --glass-border: rgba(255, 255, 255, 0.12);
            --font-header: 'Cinzel', serif;
            --font-body: 'Lora', serif;
            --font-ui: 'Montserrat', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #050505; color: #e0e0e0;
            font-family: var(--font-ui); overflow: hidden;
            height: 100vh; width: 100vw; user-select: none;
        }

        /* --- TRANSITION & BG --- */
        #transition-curtain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 9999; opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }
        body.is-transitioning #transition-curtain { opacity: 1; pointer-events: all; }

        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .background-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2; background-color: #111;
            background-size: cover; background-position: center;
            transition: filter 0.6s ease;
        }

        #app-container { 
            position: relative; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column; padding: 1.5rem 2rem;
        }

        /* --- GLASS UI --- */
        .glass-box {
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); transition: background 0.3s, border-color 0.3s;
        }
        .glass-box:hover { background: rgba(20, 20, 20, 0.65); border-color: rgba(255, 255, 255, 0.2); }
        .btn-large {
            padding: 0.8rem 2rem; font-family: var(--font-header); font-size: 0.9rem; letter-spacing: 2px;
            background: transparent; border: 1px solid var(--accent-color);
            color: var(--primary-color); cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; gap: 0.8rem;
        }
        .btn-large:hover { background: var(--accent-color); color: #000; box-shadow: 0 0 15px var(--accent-color); }

        /* --- HEADER --- */
        #main-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.8rem 2rem; margin-bottom: 0.5rem; flex-shrink: 0; z-index: 20; height: 70px;
        }
        .logo { font-family: var(--font-header); font-size: 1.6rem; letter-spacing: 4px; color: var(--primary-color); text-shadow: 0 0 10px rgba(255,255,255,0.2); cursor: pointer; }
        .header-controls { display: flex; gap: 15px; align-items: center; }
        .control-icon { color: #888; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .control-icon:hover { color: var(--accent-color); }

        /* --- CONTENT STAGE --- */
        #content-stage {
            flex: 1; overflow-y: auto; overflow-x: hidden; padding: 10px; display: flex; flex-direction: column;
            scrollbar-width: thin; scrollbar-color: var(--accent-color) rgba(0,0,0,0.3);
        }

        /* --- EXPANSION BAR (NEW) --- */
        .expansion-bar {
            width: 100%; max-width: 850px; margin: 1.5rem auto 0 auto;
            padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between;
        }
        .exp-title { font-family: var(--font-header); font-size: 1.1rem; color: #ccc; letter-spacing: 2px; }
        .exp-nav { display: flex; gap: 1.5rem; }
        .exp-link { cursor: pointer; color: var(--accent-color); font-size: 0.9rem; text-transform: uppercase; font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .exp-link:hover { text-shadow: 0 0 10px var(--accent-color); color: #fff; }

        /* --- VIEW: STORY HUB --- */
        .story-hub-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-bottom: 2rem; }
        .story-hub-layout {
            display: grid; grid-template-columns: 220px 1fr; gap: 2.5rem;
            width: 100%; max-width: 850px; padding: 2rem !important; align-items: center;
        }
        .hub-cover { width: 100%; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .hub-details h1 { font-family: var(--font-header); font-size: 2.2rem; margin-bottom: 0.5rem; line-height: 1.1; color: #fff; }
        .hub-synopsis { font-size: 1rem; line-height: 1.6; color: #ddd; margin-bottom: 2rem; max-height: 200px; overflow-y: auto; padding-right: 10px; }

        /* --- VIEW: TIMELINE (Snake Path) --- */
        .timeline-container { max-width: 900px; margin: 0 auto; position: relative; padding: 4rem 0; }
        .timeline-line {
            position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; background: rgba(255,255,255,0.1); transform: translateX(-50%);
        }
        .timeline-node {
            position: relative; width: 100%; min-height: 100px; margin-bottom: 2rem;
            display: flex; justify-content: center; align-items: center;
        }
        .node-point {
            position: absolute; left: 50%; width: 16px; height: 16px; background: #000;
            border: 2px solid var(--accent-color); border-radius: 50%; transform: translateX(-50%);
            z-index: 2; transition: 0.3s;
        }
        .node-content {
            width: 45%; padding: 1.5rem; position: relative;
            background: rgba(20,20,20,0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
            transition: 0.3s; cursor: default;
        }
        .node-left .node-content { margin-right: auto; text-align: right; }
        .node-right .node-content { margin-left: auto; text-align: left; }
        
        .timeline-node:hover .node-point { background: var(--accent-color); box-shadow: 0 0 15px var(--accent-color); }
        .timeline-node:hover .node-content { border-color: var(--accent-color); transform: scale(1.02); background: rgba(30,30,30,0.95); }
        
        .node-date { color: var(--accent-color); font-size: 0.85rem; font-weight: bold; margin-bottom: 0.5rem; font-family: var(--font-ui); }
        .node-title { font-family: var(--font-header); font-size: 1.2rem; color: #fff; margin-bottom: 0.5rem; }
        .node-desc { font-size: 0.9rem; color: #bbb; line-height: 1.5; }

        /* --- VIEW: MAPS --- */
        .map-viewer-layout { width: 100%; height: 100%; display: flex; overflow: hidden; position: relative; }
        .map-viewport { flex: 1; height: 100%; overflow: auto; cursor: grab; background: #000; display: flex; justify-content: center; align-items: center; }
        .map-viewport img { max-width: none; transition: transform 0.3s ease; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .map-sidebar { 
            width: 250px; padding: 1.5rem; z-index: 5;
            display: flex; flex-direction: column; gap: 1rem;
        }
        .map-item { 
            padding: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 10px;
        }
        .map-item:hover, .map-item.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); }
        .map-thumb { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; background: #000; }
        .map-controls {
            position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 10;
        }

        /* --- VIEW: LORE (Modified Grid) --- */
        .lore-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; max-width: 1200px; margin: 0 auto; }
        .lore-card {
            display: flex; height: 120px; overflow: hidden; cursor: pointer; transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(20,20,20,0.4);
        }
        .lore-card:hover { border-color: var(--accent-color); background: rgba(30,30,30,0.8); transform: translateX(5px); }
        .lore-img { width: 100px; height: 100%; object-fit: cover; border-right: 1px solid rgba(255,255,255,0.1); }
        .lore-info { padding: 1rem; display: flex; flex-direction: column; justify-content: center; }
        .lore-type { font-size: 0.7rem; color: var(--accent-color); text-transform: uppercase; margin-bottom: 4px; }
        .lore-title { font-family: var(--font-header); font-size: 1.1rem; color: #fff; }

        /* Reader, Home, etc (Existing styles omitted for brevity, assumed unchanged) */
        .story-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 2rem; padding: 1rem 0; max-width: 1300px; margin: 0 auto; }
        .story-card { position: relative; height: 380px; overflow: hidden; cursor: pointer; transition: 0.4s; display: flex; align-items: flex-end; }
        .story-card:hover { transform: translateY(-5px); border-color: var(--accent-color); }
        .story-card img { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; z-index: -1; transition: 0.6s; }
        .story-card:hover img { transform: scale(1.1); }
        .card-info { width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.6) 100%); padding: 1.5rem; }
        .card-title { font-family: var(--font-header); font-size: 1.2rem; color: var(--accent-color); }

        /* --- LIGHTBOX --- */
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .lightbox.active { opacity: 1; }
        .lightbox img { max-width: 95%; max-height: 95vh; border: 1px solid #333; box-shadow: 0 0 50px rgba(0,0,0,0.8); }

    </style>
</head>
<body>

    <div class="background-layer" id="global-bg"></div>
    <canvas id="particle-canvas"></canvas>
    <div id="transition-curtain"></div>
    
    <!-- AUDIO ELEMENT -->
    <audio id="bg-music" loop></audio>

    <div id="app-container">
        <nav id="main-header" class="glass-box">
            <div id="back-container"></div>
            <div class="logo" onclick="Router.navigate('home')">AETHER</div>
            <div class="header-controls">
                <!-- Audio Toggle -->
                <div class="control-icon" id="audio-btn" onclick="AudioCtrl.toggle()">
                    <i class="fas fa-volume-mute"></i>
                </div>
                <!-- Wallpaper Toggle Container -->
                <div id="wp-toggle-container"></div>
            </div>
        </nav>
        <div id="content-stage"></div>
    </div>

    <!-- Modals -->
    <div id="lightbox" class="lightbox" onclick="this.classList.remove('active'); setTimeout(()=>this.style.display='none', 300)">
        <div style="position:absolute; top:20px; right:30px; color:#fff; font-size:2rem; cursor:pointer">&times;</div>
        <img id="lightbox-img" src="" onclick="event.stopPropagation()">
    </div>

    <!-- Wallpaper Modal (Simplified for brevity) -->
    <div id="wp-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; flex-direction:column; align-items:center; justify-content:center;">
        <h2 style="color:#fff; margin-bottom:1rem">Select Wallpaper</h2>
        <div id="wp-grid" style="display:grid; gap:1rem; width:80%; max-height:70vh; overflow-y:auto; padding:2rem; background:#111;"></div>
        <button class="btn-large" onclick="document.getElementById('wp-modal').style.display='none'">Close</button>
    </div>

    <script>
        // --- AUDIO CONTROLLER ---
        const AudioCtrl = {
            el: document.getElementById('bg-music'),
            btn: document.getElementById('audio-btn'),
            isPlaying: false,
            src: 'https://cdn.pixabay.com/audio/2022/08/02/audio_884fe92c21.mp3', // Placeholder Ambient Track
            
            init: () => {
                AudioCtrl.el.src = AudioCtrl.src;
                AudioCtrl.el.volume = 0.3;
            },
            toggle: () => {
                if (AudioCtrl.isPlaying) {
                    AudioCtrl.el.pause();
                    AudioCtrl.btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                    AudioCtrl.btn.style.color = "#888";
                } else {
                    AudioCtrl.el.play().catch(e => alert("Please interact with the document first."));
                    AudioCtrl.btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    AudioCtrl.btn.style.color = "var(--accent-color)";
                }
                AudioCtrl.isPlaying = !AudioCtrl.isPlaying;
            }
        };

        // --- PARTICLES & VISUALS ---
        const Visuals = {
            init: () => {
                const canvas = document.getElementById('particle-canvas');
                const ctx = canvas.getContext('2d');
                let w, h, pArr = [];
                const resize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
                window.addEventListener('resize', resize); resize();
                
                class P {
                    constructor(){ this.x=Math.random()*w; this.y=Math.random()*h; this.s=Math.random()+0.5; this.sp=Math.random()*0.3+0.1; }
                    up(){ this.y-=this.sp; if(this.y<0){this.y=h;this.x=Math.random()*w;} }
                    dr(){ ctx.fillStyle='rgba(255,215,0,0.3)'; ctx.beginPath(); ctx.arc(this.x,this.y,this.s,0,Math.PI*2); ctx.fill(); }
                }
                for(let i=0;i<30;i++) pArr.push(new P());
                function anim(){ ctx.clearRect(0,0,w,h); pArr.forEach(p=>{p.up();p.dr()}); requestAnimationFrame(anim); }
                anim();
            }
        };

        // --- DATA & API ---
        const State = { manifest: [], currentStoryId: null, currentStoryConfig: null, currentChars: [], wallpaperChar: null, currentMap: 0 };
        
        // Helper to fetch from 'world_data' vs 'data'
        const API = { 
            get: async (path) => {
                const res = await fetch(path);
                if (!res.ok) throw new Error(`Missing: ${path}`);
                return await res.json();
            }
        };

        // --- RENDERER ---
        const Render = {
            stage: document.getElementById('content-stage'),
            
            home: async () => {
                try {
                    const settings = await API.get('data/settings.json').catch(()=>({}));
                    UI.setBg(settings.homeBg);
                    State.manifest = await API.get('data/manifest.json');
                    UI.setBackButton(null);
                    
                    let html = '<div class="story-grid">';
                    State.manifest.forEach(s => html += `
                        <div class="story-card glass-box" onclick="Router.navigate('story/${s.id}')">
                            <img src="${s.cover}"><div class="card-info"><div class="card-title">${s.title}</div></div>
                        </div>`);
                    Render.stage.innerHTML = html + '</div>';
                } catch(e) { Render.stage.innerHTML = `<div style="text-align:center;color:red">${e.message}</div>`; }
            },

            // --- 2. UPDATED STORY HUB ---
            storyHub: async (id) => {
                UI.setBackButton("Router.navigate('home')", "Archives");
                State.currentStoryId = id;
                try {
                    State.currentStoryConfig = await API.get(`data/stories/${id}/config.json`);
                    State.manifest = await API.get('data/manifest.json');
                    
                    // Fetch Meta for Expansion Bar Title (Optional, defaults to Story Title)
                    let meta = { worldTitle: "Explore the World" };
                    try { meta = await API.get(`world_data/${id}/meta.json`); } catch(e){}

                    UI.setBg(State.currentStoryConfig.bg);
                    const story = State.manifest.find(s => s.id === id) || { cover: "" };
                    const conf = State.currentStoryConfig;
                    document.documentElement.style.setProperty('--accent-color', conf.themeColor);

                    Render.stage.innerHTML = `
                        <div class="story-hub-wrapper">
                            <div class="story-hub-layout glass-box">
                                <img class="hub-cover" src="${story.cover}">
                                <div class="hub-details">
                                    <h1>${conf.title}</h1>
                                    <div style="color:var(--accent-color);margin-bottom:1rem">${conf.genre}</div>
                                    <div class="hub-synopsis">${conf.synopsis}</div>
                                    <div class="hub-actions">
                                        <button class="btn-large" onclick="Router.navigate('read/${id}')"><i class="fas fa-book-open"></i> READ</button>
                                        <button class="btn-large" onclick="Router.navigate('gallery/${id}')"><i class="fas fa-images"></i> ROSTER</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- THE NEW EXPANSION BAR -->
                            <div class="expansion-bar glass-box">
                                <div class="exp-title">[ ${meta.worldTitle} ]</div>
                                <div class="exp-nav">
                                    <div class="exp-link" onclick="Router.navigate('timeline/${id}')"><i class="fas fa-stream"></i> Timeline</div>
                                    <div class="exp-link" onclick="Router.navigate('maps/${id}')"><i class="fas fa-map-marked-alt"></i> Maps</div>
                                    <div class="exp-link" onclick="Router.navigate('lore/${id}')"><i class="fas fa-book"></i> Lore</div>
                                </div>
                            </div>
                        </div>`;
                } catch(e) { alert(e.message); }
            },

            // --- 3. TIMELINE RENDERER (Snake Path) ---
            timeline: async (id) => {
                UI.setBackButton(`Router.navigate('story/${id}')`, "Hub");
                try {
                    const events = await API.get(`world_data/${id}/timeline.json`);
                    let html = `<div class="timeline-container"><div class="timeline-line"></div>`;
                    
                    events.forEach((ev, i) => {
                        const side = i % 2 === 0 ? 'node-left' : 'node-right';
                        html += `
                            <div class="timeline-node ${side}">
                                <div class="node-point"></div>
                                <div class="node-content glass-box">
                                    <div class="node-date">${ev.date}</div>
                                    <div class="node-title">${ev.title}</div>
                                    <div class="node-desc">${ev.desc}</div>
                                </div>
                            </div>`;
                    });
                    Render.stage.innerHTML = html + '</div>';
                } catch(e) { Render.stage.innerHTML = `<div style="text-align:center; padding:3rem">Timeline data not found in <code>world_data/${id}/timeline.json</code></div>`; }
            },

            // --- 4. MAPS RENDERER ---
            maps: async (id) => {
                try {
                    const maps = await API.get(`world_data/${id}/maps.json`);
                    let sidebarHtml = '';
                    
                    // Render Sidebar Items
                    maps.forEach((m, i) => {
                        sidebarHtml += `
                            <div class="map-item glass-box" onclick="Render.switchMap('${m.src}', this)">
                                <img src="${m.src}" class="map-thumb">
                                <div>${m.name}</div>
                            </div>`;
                    });

                    Render.stage.innerHTML = `
                        <div class="map-viewer-layout">
                            <div class="map-sidebar glass-box" style="margin-right:1rem;">
                                <div class="back-btn-wrapper" onclick="Router.navigate('story/${id}')" style="margin-bottom:1rem"><i class="fas fa-arrow-left"></i> BACK</div>
                                <h3 style="font-family:var(--font-header); margin-bottom:1rem">Locations</h3>
                                ${sidebarHtml}
                            </div>
                            <div class="map-viewport glass-box" id="map-port">
                                <img id="map-img" src="${maps[0].src}">
                                <div class="map-controls">
                                    <button class="btn-large" style="padding:0.5rem 1rem" onclick="Render.zoomMap(0.1)">+</button>
                                    <button class="btn-large" style="padding:0.5rem 1rem" onclick="Render.zoomMap(-0.1)">-</button>
                                </div>
                            </div>
                        </div>`;
                    
                    // Store current zoom state
                    State.mapZoom = 1;
                } catch(e) { Render.stage.innerHTML = `<div style="text-align:center; padding:3rem">Map data not found in <code>world_data/${id}/maps.json</code></div>`; }
            },

            // Map Helpers
            switchMap: (src, el) => {
                document.getElementById('map-img').src = src;
                document.querySelectorAll('.map-item').forEach(d => d.classList.remove('active'));
                if(el) el.classList.add('active');
                State.mapZoom = 1; Render.zoomMap(0);
            },
            zoomMap: (delta) => {
                State.mapZoom += delta;
                if(State.mapZoom < 0.5) State.mapZoom = 0.5;
                document.getElementById('map-img').style.transform = `scale(${State.mapZoom})`;
            },

            // --- 5. LORE RENDERER ---
            lore: async (id) => {
                UI.setBackButton(`Router.navigate('story/${id}')`, "Hub");
                try {
                    const lore = await API.get(`world_data/${id}/lore.json`);
                    let html = '<div class="lore-grid">';
                    lore.forEach(item => {
                        html += `
                            <div class="lore-card" onclick="UI.openLightbox('${item.img}')">
                                <img src="${item.img}" class="lore-img">
                                <div class="lore-info">
                                    <div class="lore-type">${item.type}</div>
                                    <div class="lore-title">${item.title}</div>
                                    <div style="font-size:0.8rem; color:#aaa; margin-top:5px">${item.desc.substring(0, 60)}...</div>
                                </div>
                            </div>`;
                    });
                    Render.stage.innerHTML = html + '</div>';
                } catch(e) { Render.stage.innerHTML = `<div style="text-align:center; padding:3rem">Lore data not found in <code>world_data/${id}/lore.json</code></div>`; }
            },

            // Existing Reader/Gallery logic omitted for brevity (Keep your existing code for Reader/Gallery here)
            // ...
            reader: async (id, chIdx=0) => { alert("Reader loaded (Use previous code logic here)"); },
            gallery: async (id, charId=null) => { alert("Gallery loaded (Use previous code logic here)"); }
        };

        const UI = {
            setBg: (url) => { if(url) document.getElementById('global-bg').style.backgroundImage = `url('${url}')`; },
            setBackButton: (act, lbl) => document.getElementById('back-container').innerHTML = act ? `<div class="back-btn-wrapper" onclick="${act}"><i class="fas fa-arrow-left"></i> ${lbl}</div>` : '',
            openLightbox: (src) => { 
                const lb=document.getElementById('lightbox'); document.getElementById('lightbox-img').src=src; 
                lb.style.display='flex'; setTimeout(()=>lb.classList.add('active'),10); 
            }
        };

        const Router = {
            navigate: (h) => {
                document.body.classList.add('is-transitioning');
                setTimeout(() => window.location.hash = h, 400); 
            },
            handle: () => {
                const p = (window.location.hash.slice(1) || 'home').split('/');
                (async () => {
                    if (p[0] === 'home') await Render.home();
                    else if (p[0] === 'story') await Render.storyHub(p[1]);
                    else if (p[0] === 'read') await Render.reader(p[1], p[2]); // Ensure you paste your Reader logic back
                    else if (p[0] === 'gallery') await Render.gallery(p[1], p[2]); // Ensure you paste your Gallery logic back
                    else if (p[0] === 'timeline') await Render.timeline(p[1]);
                    else if (p[0] === 'maps') await Render.maps(p[1]);
                    else if (p[0] === 'lore') await Render.lore(p[1]);
                })().then(() => setTimeout(() => document.body.classList.remove('is-transitioning'), 100));
            }
        };

        window.addEventListener('hashchange', Router.handle);
        window.addEventListener('DOMContentLoaded', () => { 
            Router.handle(); Visuals.init(); AudioCtrl.init(); 
        });
    </script>
</body>
</html>
